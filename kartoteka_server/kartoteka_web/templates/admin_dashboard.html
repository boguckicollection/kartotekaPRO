{% extends "base.html" %}
{% block title %}Panel Administratora - Kartoteka{% endblock %}

{% block head_extra %}
<style>
/* Zinc Admin Styles */
.admin-header {
  background: #09090b;
  border-bottom: 1px solid #27272a;
  padding: 24px 0;
}

.admin-content {
  background: #000000;
  padding: 24px 0;
  min-height: calc(100vh - 200px);
}

.admin-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: #18181b;
  border: 1px solid #27272a;
  border-radius: 12px;
  padding: 20px;
  display: flex;
  flex-direction: column;
}

.stat-label {
  font-size: 12px;
  font-weight: 500;
  color: #a1a1aa;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: #fafafa;
  line-height: 1;
}

.stat-desc {
  font-size: 12px;
  color: #71717a;
  margin-top: 8px;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.data-table th {
  text-align: left;
  padding: 12px 16px;
  color: #a1a1aa;
  font-weight: 500;
  border-bottom: 1px solid #27272a;
  background: #18181b;
}

.data-table td {
  padding: 12px 16px;
  color: #fafafa;
  border-bottom: 1px solid #27272a;
}

.data-table tr:hover td {
  background: #27272a;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
}

.status-active {
  background: rgba(34, 197, 94, 0.1);
  color: #22c55e;
  border: 1px solid rgba(34, 197, 94, 0.2);
}

.status-admin {
  background: rgba(99, 102, 241, 0.1);
  color: #6366f1;
  border: 1px solid rgba(99, 102, 241, 0.2);
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  color: #fafafa;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.panel-card {
  background: #18181b;
  border: 1px solid #27272a;
  border-radius: 12px;
  overflow: hidden;
}
</style>
{% endblock %}

{% block content %}
<section class="admin-header">
  <div class="container mx-auto px-4 max-w-6xl">
    <div class="flex items-center gap-3 mb-2">
      <div class="p-2 bg-red-500/10 rounded-lg border border-red-500/20">
        <i data-lucide="shield-alert" class="w-6 h-6 text-red-500"></i>
      </div>
      <h1 class="text-2xl font-bold text-white">Panel Administratora</h1>
    </div>
    <p class="text-sm text-zinc-400 ml-14">Witaj, {{ username }}! Zarządzaj systemem i monitoruj statystyki.</p>
  </div>
</section>

<section class="admin-content">
  <div class="container mx-auto px-4 max-w-6xl">
    
    <!-- Stats Grid -->
    <div class="admin-grid">
      <div class="stat-card">
        <span class="stat-label">Użytkownicy</span>
        <span class="stat-value">{{ stats.total_users }}</span>
        <span class="stat-desc">Zarejestrowani w systemie</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Karty w bazie</span>
        <span class="stat-value">{{ stats.total_cards }}</span>
        <span class="stat-desc">Unikalne rekordy kart</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Kolekcje użytkowników</span>
        <span class="stat-value">{{ stats.total_collections }}</span>
        <span class="stat-desc">Aktywne kolekcje</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Status Systemu</span>
        <span class="stat-value text-emerald-500">ONLINE</span>
        <span class="stat-desc">Wersja 1.0.0</span>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- Users Table -->
      <div class="lg:col-span-2">
        <h2 class="section-title">
          <i data-lucide="users" class="w-5 h-5 text-zinc-400"></i>
          Ostatni Użytkownicy
        </h2>
        <div class="panel-card">
          <div class="overflow-x-auto">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nazwa</th>
                  <th>Email</th>
                  <th>Rola</th>
                  <th>Data utworzenia</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr>
                  <td>#{{ user.id }}</td>
                  <td class="font-medium">{{ user.username }}</td>
                  <td class="text-zinc-500">{{ user.email or '-' }}</td>
                  <td>
                    {% if user.is_admin %}
                    <span class="status-badge status-admin">ADMIN</span>
                    {% else %}
                    <span class="status-badge status-active">USER</span>
                    {% endif %}
                  </td>
                  <td class="text-zinc-500">{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- System Info -->
      <div>
        <h2 class="section-title">
          <i data-lucide="server" class="w-5 h-5 text-zinc-400"></i>
          Baza Danych
        </h2>
        <div class="panel-card p-6 space-y-4">
          <div>
            <div class="text-xs text-zinc-500 uppercase tracking-wider mb-1">Całkowita wartość kolekcji</div>
            <div class="text-xl font-bold text-indigo-400">{{ "%.2f"|format(stats.total_value) }} PLN</div>
          </div>
          <div class="h-px bg-zinc-800"></div>
          <div>
            <div class="text-xs text-zinc-500 uppercase tracking-wider mb-1">Produkty w bazie</div>
            <div class="text-lg font-semibold text-white">{{ stats.total_products }}</div>
          </div>
          <div class="h-px bg-zinc-800"></div>
          <div>
            <div class="text-xs text-zinc-500 uppercase tracking-wider mb-1">Ostatnia synchronizacja</div>
            <div class="text-sm text-zinc-300 flex items-center gap-2">
              <i data-lucide="clock" class="w-4 h-4 text-zinc-500"></i>
              Dzisiaj, 14:30
            </div>
          </div>
          
          <div class="mt-6 space-y-2">
            <div class="alert bg-zinc-900 border border-zinc-800 text-zinc-300 px-3 py-2 rounded text-xs" id="admin-alert" hidden></div>
            <button id="sync-prices-btn" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white py-2 px-4 rounded-md text-xs font-medium transition-colors border border-zinc-700">
              Wymuś synchronizację cen
            </button>
            <button id="sync-catalog-btn" class="w-full bg-zinc-800 hover:bg-zinc-700 text-white py-2 px-4 rounded-md text-xs font-medium transition-colors border border-zinc-700">
              Aktualizuj katalog kart
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();

    const alertBox = document.getElementById("admin-alert");
    const syncPricesBtn = document.getElementById("sync-prices-btn");
    const syncCatalogBtn = document.getElementById("sync-catalog-btn");

    const apiFetch = async (path, options = {}) => {
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('kartoteka_token')}`,
            ...(options.headers || {})
        };
        const response = await fetch(path, { ...options, headers });
        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.detail || "Błąd serwera");
        }
        return response.json();
    };

    const handleSync = async (btn, endpoint) => {
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Przetwarzanie...";
        alertBox.hidden = true;
        alertBox.className = "alert bg-zinc-900 border border-zinc-800 text-zinc-300 px-3 py-2 rounded text-xs";

        try {
            const data = await apiFetch(endpoint, { method: "POST" });
            alertBox.textContent = `${data.message} (Zaktualizowano: ${data.details.updated}, Dodano: ${data.details.added})`;
            alertBox.className = "alert bg-green-500/10 border border-green-500/20 text-green-400 px-3 py-2 rounded text-xs";
            alertBox.hidden = false;
        } catch (error) {
            alertBox.textContent = `Błąd: ${error.message}`;
            alertBox.className = "alert bg-red-500/10 border border-red-500/20 text-red-400 px-3 py-2 rounded text-xs";
            alertBox.hidden = false;
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    };

    if (syncPricesBtn) {
        syncPricesBtn.addEventListener("click", () => handleSync(syncPricesBtn, "/api/admin/tools/sync-prices"));
    }
    if (syncCatalogBtn) {
        syncCatalogBtn.addEventListener("click", () => handleSync(syncCatalogBtn, "/api/admin/tools/sync-catalog"));
    }
  });
</script>
{% endblock %}
