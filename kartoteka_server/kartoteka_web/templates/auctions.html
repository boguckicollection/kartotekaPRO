{% extends "base.html" %}
{% block title %}Licytacje - Kartoteka{% endblock %}

{% block head_extra %}
<style>
/* Hero & Panel Styles (Matching Add Card) */
.search-hero {
  background: radial-gradient(circle at top center, #18181b 0%, #09090b 100%);
  border-bottom: 1px solid #27272a;
  padding: 60px 24px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.search-hero::before {
  content: "";
  position: absolute;
  top: 0; left: 50%; transform: translateX(-50%);
  width: 100%; height: 100%;
  background: url("{{ url_for('static', path='/img/grid.svg') }}") center top no-repeat;
  opacity: 0.1;
  pointer-events: none;
}
.search-panel {
  background: #000000;
  padding: 40px 0;
  min-height: calc(100vh - 300px);
}

/* Card Hover Effects */
.auction-card {
    background: #18181b; /* zinc-900 */
    border: 1px solid #27272a; /* zinc-800 */
    border-radius: 1rem; /* rounded-2xl */
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}
.auction-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
    border-color: #6366f1; /* Indigo-500 border on hover */
}
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="search-hero">
  <div class="container mx-auto px-4 max-w-3xl">
    <div class="inline-flex items-center px-3 py-1 bg-amber-500/10 border border-amber-500/20 rounded-full text-xs font-medium text-amber-400 mb-6">
      <i data-lucide="gavel" class="w-3 h-3 mr-1.5"></i>
      Rynek Licytacji
    </div>
    
    <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight mb-4">Licytuj unikalne karty</h1>
    <p class="text-zinc-400 text-lg max-w-xl mx-auto leading-relaxed">
      Dołącz do licytacji i zdobywaj rzadkie okazy do swojej kolekcji w najlepszych cenach.
    </p>
  </div>
</section>

<!-- Auctions Grid Section -->
<section class="search-panel">
  <div class="container mx-auto px-4 max-w-7xl">
      <div id="auctions-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        <!-- Loading State -->
        <div class="col-span-full flex flex-col items-center justify-center py-24 text-zinc-500">
          <div class="loading loading-spinner loading-lg text-indigo-500 mb-4"></div>
          <p>Ładowanie aukcji...</p>
        </div>
      </div>
  </div>
</section>

<!-- Bid Modal -->
<div id="bid-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" aria-hidden="true">
  <div class="bg-zinc-900 border border-zinc-800 rounded-2xl w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300" id="bid-modal-content">
    <div class="flex justify-between items-center p-5 border-b border-zinc-800">
      <h2 class="text-lg font-bold text-white flex items-center gap-2">
        <i data-lucide="zap" class="w-5 h-5 text-amber-400"></i>
        Licytuj
      </h2>
      <button class="close-button text-zinc-400 hover:text-white p-2 rounded-lg hover:bg-zinc-800 transition-colors">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <div class="p-6 space-y-4">
      <div class="flex justify-between items-center bg-zinc-950 p-4 rounded-xl border border-zinc-800">
        <span class="text-zinc-400 text-sm">Aktualna cena</span>
        <span id="modal-price" class="text-2xl font-bold text-emerald-400 font-mono">0.00 PLN</span>
      </div>
      <form id="bid-form" class="space-y-4">
        <input type="hidden" id="auction-id">
        <div class="space-y-2">
          <label class="block text-xs font-medium text-zinc-400 uppercase tracking-wider">Twoja oferta</label>
          <div class="relative">
            <input type="number" id="bid-amount" step="1" required class="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-white text-lg font-mono focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-colors" placeholder="0.00">
            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 font-medium">PLN</span>
          </div>
          <p class="text-xs text-zinc-500">Minimalna oferta: <span id="modal-min-bid" class="text-zinc-300 font-bold">0.00</span> PLN</p>
        </div>
        <button type="submit" class="w-full py-3.5 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-900/20 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
          <i data-lucide="gavel" class="w-5 h-5"></i>
          Złóż Ofertę
        </button>
      </form>
      <div id="bid-msg" class="hidden p-3 rounded-lg text-sm text-center font-medium"></div>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div id="login-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 transition-opacity duration-300" aria-hidden="true">
  <div class="bg-zinc-900 border border-zinc-800 rounded-2xl w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300" id="login-modal-content">
    <div class="flex justify-between items-center p-5 border-b border-zinc-800">
      <h2 class="text-lg font-bold text-white flex items-center gap-2">
        <i data-lucide="log-in" class="w-5 h-5 text-indigo-400"></i>
        Zaloguj się
      </h2>
      <button onclick="closeLoginModal()" class="text-zinc-400 hover:text-white p-2 rounded-lg hover:bg-zinc-800 transition-colors">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <div class="p-6 space-y-4">
      <p class="text-zinc-400 text-sm mb-4">Aby wziąć udział w licytacji, musisz być zalogowany.</p>
      <form id="login-form" class="space-y-4">
        <div>
            <label class="block text-xs font-medium text-zinc-400 uppercase tracking-wider mb-1">Nazwa użytkownika</label>
            <input type="text" id="login-username" required class="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-colors">
        </div>
        <div>
            <label class="block text-xs font-medium text-zinc-400 uppercase tracking-wider mb-1">Hasło</label>
            <input type="password" id="login-password" required class="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-colors">
        </div>
        <button type="submit" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-900/20 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
          Zaloguj się
        </button>
      </form>
      <div id="login-msg" class="hidden p-3 rounded-lg text-sm text-center font-medium"></div>
      <div class="text-center mt-4">
        <a href="/register" class="text-xs text-indigo-400 hover:text-indigo-300">Nie masz konta? Zarejestruj się</a>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = `http://${window.location.hostname}:8000/auctions`; 
const USER_ID = {{ user_id or 'null' }};
const USERNAME = "{{ username or '' }}";

async function loadAuctions() {
    try {
        const res = await fetch(`${API_BASE}/?status=active`);
        if (!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        const container = document.getElementById('auctions-grid');
        container.innerHTML = '';

        if (!data.items || data.items.length === 0) {
            container.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-24 text-zinc-600">
                    <i data-lucide="inbox" class="w-16 h-16 mb-4 opacity-20"></i>
                    <p class="text-lg font-medium">Brak aktywnych licytacji</p>
                    <p class="text-sm">Zajrzyj ponownie później.</p>
                </div>
            `;
            if (window.lucide) lucide.createIcons();
            return;
        }

        data.items.forEach(auction => {
            const card = document.createElement('div');
            card.className = 'auction-card group';
            
            // Timer logic
            let timeLeft = auction.time_remaining;
            const timerId = `timer-${auction.id}`;
            const imgUrl = auction.image_url || '/static/img/box.png';
            
            card.innerHTML = `
                <div class="relative aspect-[4/3] bg-zinc-950 overflow-hidden p-6 border-b border-zinc-800">
                    <div class="absolute top-3 right-3 bg-black/80 backdrop-blur-md text-white text-xs font-mono px-2 py-1 rounded-lg border border-white/10 z-10 flex items-center gap-1.5">
                        <i data-lucide="clock" class="w-3 h-3 text-amber-400"></i>
                        <span id="${timerId}" class="font-bold tracking-tight">...</span>
                    </div>
                    <a href="/auctions/${auction.id}" class="block w-full h-full">
                        <img src="${imgUrl}" alt="${auction.title}" class="w-full h-full object-contain transform group-hover:scale-110 transition-transform duration-500 ease-out">
                    </a>
                </div>
                
                <div class="p-6 flex-1 flex flex-col">
                    <a href="/auctions/${auction.id}" class="group-hover:text-indigo-400 transition-colors">
                        <h3 class="text-white font-bold text-xl mb-4 line-clamp-2 leading-tight">${auction.title}</h3>
                    </a>
                    
                    <div class="mt-auto pt-4 border-t border-zinc-800/50">
                        <div class="flex justify-between items-end mb-5">
                            <div>
                                <p class="text-[10px] text-zinc-500 uppercase tracking-wider mb-0.5">Aktualna cena</p>
                                <p class="text-2xl font-bold text-emerald-400 font-mono tracking-tight">${auction.current_price} <span class="text-sm text-emerald-600">PLN</span></p>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] text-zinc-500 uppercase tracking-wider mb-0.5">Ofert</p>
                                <p class="text-sm font-medium text-white flex items-center justify-end gap-1">
                                    <i data-lucide="users" class="w-3.5 h-3.5 text-indigo-400"></i>
                                    ${auction.bid_count || 0}
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <a href="/auctions/${auction.id}" class="flex-1 py-3 bg-zinc-800 hover:bg-zinc-700 hover:text-white text-zinc-300 font-medium rounded-xl transition-colors flex items-center justify-center gap-2 border border-zinc-700 hover:border-zinc-600">
                                Szczegóły
                            </a>
                            <button onclick="openBid(${auction.id}, ${auction.current_price}, ${auction.min_increment})" 
                                class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl transition-all shadow-lg shadow-indigo-900/20 active:scale-[0.98] flex items-center justify-center gap-2">
                                <i data-lucide="gavel" class="w-4 h-4"></i>
                                Licytuj
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
            startTimer(timerId, timeLeft);
        });
        
        if (window.lucide) lucide.createIcons();
        
    } catch (e) {
        document.getElementById('auctions-grid').innerHTML = `
            <div class="col-span-full p-8 bg-red-500/10 border border-red-500/20 text-red-400 rounded-2xl text-center">
                <p class="font-bold mb-1">Nie udało się załadować aukcji</p>
                <p class="text-sm opacity-80">Sprawdź połączenie z serwerem API (port 8000).</p>
            </div>
        `;
        console.error(e);
    }
}

function startTimer(elementId, seconds) {
    const el = document.getElementById(elementId);
    if (!el) return;
    updateTimerText(el, seconds);
    const interval = setInterval(() => {
        seconds--;
        if (seconds <= 0) {
            el.innerHTML = '<span class="text-red-400">Zakończona</span>';
            clearInterval(interval);
            return;
        }
        updateTimerText(el, seconds);
    }, 1000);
}

function updateTimerText(el, seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    
    let text = "";
    if (h > 0) text += `${h}h `;
    text += `${m}m ${s}s`;
    
    if (seconds < 300) {
        el.classList.add('text-red-400');
        el.classList.add('animate-pulse');
    }
    el.textContent = text;
}

// Modal Logic (Same as before)
const modal = document.getElementById('bid-modal');
const modalContent = document.getElementById('bid-modal-content');
const form = document.getElementById('bid-form');
const msgDiv = document.getElementById('bid-msg');
const loginModal = document.getElementById('login-modal');
const loginContent = document.getElementById('login-modal-content');
const loginForm = document.getElementById('login-form');
const loginMsg = document.getElementById('login-msg');

window.openBid = function(id, currentPrice, increment) {
    if (!USER_ID || USER_ID === 'null') { openLoginModal(); return; }
    document.getElementById('auction-id').value = id;
    document.getElementById('modal-price').textContent = currentPrice.toFixed(2) + " PLN";
    const minBid = currentPrice + increment;
    document.getElementById('modal-min-bid').textContent = minBid.toFixed(2);
    const bidInput = document.getElementById('bid-amount');
    bidInput.value = minBid; bidInput.min = minBid;
    msgDiv.className = 'hidden'; modal.classList.remove('hidden');
    requestAnimationFrame(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); });
}
function closeModal() { modal.classList.add('opacity-0'); modalContent.classList.remove('scale-100'); modalContent.classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }
function openLoginModal() { loginModal.classList.remove('hidden'); requestAnimationFrame(() => { loginModal.classList.remove('opacity-0'); loginContent.classList.remove('scale-95'); loginContent.classList.add('scale-100'); }); }
function closeLoginModal() { loginModal.classList.add('opacity-0'); loginContent.classList.remove('scale-100'); loginContent.classList.add('scale-95'); setTimeout(() => { loginModal.classList.add('hidden'); }, 300); }
document.querySelectorAll('.close-button').forEach(btn => btn.onclick = () => { closeModal(); closeLoginModal(); });
modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
loginModal.addEventListener('click', (e) => { if (e.target === loginModal) closeLoginModal(); });

form.onsubmit = async (e) => {
    e.preventDefault();
    const id = document.getElementById('auction-id').value;
    const amount = document.getElementById('bid-amount').value;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true; submitBtn.innerHTML = 'Przetwarzanie...';
    try {
        await fetch(`${API_BASE}/sync-user`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ kartoteka_user_id: USER_ID, username: USERNAME, is_active: true }) });
        const res = await fetch(`${API_BASE}/${id}/bids`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ amount: parseFloat(amount), kartoteka_user_id: USER_ID, username: USERNAME }) });
        if (!res.ok) throw new Error((await res.json()).detail || 'Błąd');
        msgDiv.textContent = "Sukces!"; msgDiv.className = 'p-3 rounded-lg text-sm text-center font-medium bg-emerald-500/10 text-emerald-400 block';
        setTimeout(() => { closeModal(); loadAuctions(); }, 1000);
    } catch (err) {
        msgDiv.textContent = err.message; msgDiv.className = 'p-3 rounded-lg text-sm text-center font-medium bg-red-500/10 text-red-400 block';
        submitBtn.disabled = false; submitBtn.innerHTML = originalText;
    }
};

loginForm.onsubmit = async (e) => {
    e.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    try {
        const res = await fetch('/users/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username, password}) });
        if (!res.ok) throw new Error((await res.json()).detail);
        window.location.reload();
    } catch (err) {
        document.getElementById('login-msg').textContent = err.message;
        document.getElementById('login-msg').className = 'p-3 rounded-lg text-sm text-center font-medium bg-red-500/10 text-red-400 block';
    }
};

loadAuctions();
</script>
{% endblock %}
