{% extends "base.html" %}
{% block title %}Porównywarka Cen - Kartoteka{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">Porównywarka Cen TCG</h1>
        <p class="text-zinc-400">Szukaj w polskich sklepach: BoosterPoint, LootQuest, i innych.</p>
    </div>

    <div class="bg-zinc-900 p-6 rounded-2xl border border-zinc-800 mb-8 shadow-lg">
        <form id="search-form" class="flex gap-3">
            <input type="text" id="search-query" placeholder="Wpisz nazwę produktu (np. 151 Booster Bundle)..." class="flex-1 bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-white outline-none focus:border-indigo-500 transition-colors">
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold transition-colors flex items-center gap-2">
                <i data-lucide="search"></i>
                <span class="hidden sm:inline">Szukaj</span>
            </button>
        </form>
    </div>

    <div id="results-container" class="space-y-4">
        <!-- Results injected here -->
        <div class="text-center text-zinc-500 py-12">
            <i data-lucide="shopping-bag" class="w-12 h-12 mx-auto mb-4 opacity-20"></i>
            <p>Wpisz nazwę produktu powyżej, aby rozpocząć wyszukiwanie.</p>
        </div>
    </div>
</div>

<script>
document.getElementById('search-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const query = document.getElementById('search-query').value.trim();
    if (!query) return;

    const container = document.getElementById('results-container');
    container.innerHTML = `
        <div class="flex flex-col items-center justify-center py-12">
            <span class="loading loading-spinner loading-lg text-indigo-500 mb-4"></span>
            <p class="text-zinc-400">Przeszukuję sklepy... (to może potrwać do 10s)</p>
        </div>
    `;

    try {
        const res = await fetch(`/products/prices/compare-pl?query=${encodeURIComponent(query)}`);
        const data = await res.json();
        
        container.innerHTML = '';
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="text-center text-zinc-500 py-12">Brak wyników lub błąd wyszukiwania.</div>';
            return;
        }

        const found = data.filter(r => r.found);
        
        if (found.length === 0) {
            container.innerHTML = '<div class="text-center text-zinc-500 py-12">Nie znaleziono produktu w żadnym sklepie.</div>';
            return;
        }

        // Sort by price
        found.sort((a, b) => a.price - b.price);

        found.forEach((item, idx) => {
            const isBest = idx === 0;
            const el = document.createElement('div');
            el.className = `bg-zinc-900 border ${isBest ? 'border-emerald-500/50 ring-1 ring-emerald-500/20' : 'border-zinc-800'} rounded-xl p-4 flex flex-col sm:flex-row items-start sm:items-center gap-4 hover:border-zinc-700 transition-all`;
            
            el.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-bold text-zinc-500 uppercase">${item.shop_name}</span>
                        ${isBest ? '<span class="px-2 py-0.5 bg-emerald-500/20 text-emerald-400 text-[10px] font-bold rounded-full">NAJTANIEJ</span>' : ''}
                    </div>
                    <h3 class="text-white font-bold text-lg leading-tight mb-1"><a href="${item.link}" target="_blank" class="hover:text-indigo-400 transition-colors">${item.product_name}</a></h3>
                    <div class="flex items-center gap-2">
                        ${item.available ? 
                            '<span class="text-emerald-500 text-xs flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> Dostępny</span>' : 
                            '<span class="text-red-500 text-xs flex items-center gap-1"><i data-lucide="x-circle" class="w-3 h-3"></i> Niedostępny</span>'}
                    </div>
                </div>
                <div class="text-right w-full sm:w-auto flex sm:flex-col justify-between items-center sm:items-end">
                    <div class="text-2xl font-bold text-white font-mono">${item.price.toFixed(2)} zł</div>
                    <a href="${item.link}" target="_blank" class="px-4 py-2 bg-white text-black text-sm font-bold rounded-lg hover:bg-zinc-200 transition-colors mt-2">
                        Idź do sklepu
                    </a>
                </div>
            `;
            container.appendChild(el);
        });
        
        if (window.lucide) lucide.createIcons();

    } catch (e) {
        console.error(e);
        container.innerHTML = '<div class="text-center text-red-400 py-12">Wystąpił błąd podczas wyszukiwania.</div>';
    }
});
</script>
{% endblock %}
