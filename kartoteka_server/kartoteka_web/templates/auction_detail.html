{% extends "base.html" %}

{% block title %}Szczegóły Aukcji - Kartoteka{% endblock %}

{% block head_extra %}
<style>
    /* Mobile Immersive Overrides */
    @media (max-width: 1024px) {
        body > header, body > nav, body > footer {
            display: none !important;
        }
        main {
            padding-bottom: 0 !important;
            height: 100vh;
            overflow: hidden;
            background: #000;
        }
        .container {
            padding: 0 !important;
            max-width: none !important;
        }
    }

    /* Desktop Layout */
    @media (min-width: 1024px) {
        .auction-layout {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 24px;
            height: calc(100vh - 120px);
        }
        .zinc-card-wrapper {
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 3/4;
            position: relative;
            max-width: 400px;
            max-height: 55vh;
            margin: 0 auto;
            perspective: 1000px;
        }
        .panel {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
        }
        main { height: auto; overflow: visible; background: transparent; }
    }

    @keyframes flash-green {
        0% { background-color: rgba(16, 185, 129, 0.4); }
        100% { background-color: transparent; }
    }
    .flash-animate { animation: flash-green 0.8s ease-out; }
    
    .time-badge { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }

    /* Mobile Overlay */
    .mobile-bids-overlay {
        background: linear-gradient(to top, #000000 90%, rgba(0,0,0,0.8) 95%, transparent 100%);
        pointer-events: none;
        padding-top: 40px;
    }
    .mobile-bids-overlay > * { pointer-events: auto; }

    .bg-radial-gradient {
        background: radial-gradient(circle at center, #27272a 0%, #09090b 80%, #000000 100%);
    }
</style>
{% endblock %}

{% block content %}
<audio id="bid-sound" src="{{ url_for('static', path='/sounds/bit.mp3') }}" preload="auto"></audio>
<div id="loading-spinner" class="flex justify-center py-20 lg:hidden"><span class="loading loading-spinner loading-lg text-indigo-500"></span></div>

<!-- ========================================== -->
<!-- MOBILE LAYOUT (Standard Flow, Scrollable)  -->
<!-- ========================================== -->
<div class="lg:hidden flex flex-col min-h-screen bg-black text-zinc-200" id="mobile-view-container" style="display:none">
    
    <!-- 1. Sticky Header -->
    <div class="sticky top-0 z-50 bg-black/90 backdrop-blur-xl border-b border-white/10 px-4 py-3 flex justify-between items-center shadow-lg">
        <a href="/auctions" class="p-2 -ml-2 text-zinc-400 hover:text-white"><i data-lucide="arrow-left"></i></a>
        <div class="text-center">
            <div class="text-[10px] uppercase font-bold text-zinc-500 tracking-wider">Koniec za</div>
            <div class="text-amber-400 font-mono font-bold text-lg leading-none" id="mobile-timer">...</div>
        </div>
        <div class="text-right">
            <div class="text-[10px] uppercase font-bold text-zinc-500 tracking-wider">Cena</div>
            <div class="text-emerald-400 font-mono font-bold text-lg leading-none" id="mobile-price">...</div>
        </div>
    </div>

    <!-- 2. Main Card Area -->
    <div class="py-8 px-6 flex justify-center bg-radial-gradient">
        <img id="auction-image-mobile" class="w-full max-w-[300px] h-auto object-contain drop-shadow-2xl rounded-lg" src="/static/img/box.png" onerror="this.src='https://placehold.co/400x600/18181b/27272a?text=No+Image'">
    </div>

    <!-- 3. Action Bar -->
    <div class="p-4 bg-zinc-900 border-t border-zinc-800 sticky bottom-0 z-40 shadow-[0_-4px_20px_rgba(0,0,0,0.5)]">
        <button id="mobile-bid-btn" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-violet-600 text-white font-bold text-lg rounded-xl shadow-lg shadow-indigo-900/40 active:scale-95 transition-transform flex items-center justify-center gap-2 border border-white/10">
            <i data-lucide="gavel" class="w-5 h-5"></i>
            PODBIJ <span id="mobile-increment-hint" class="bg-black/20 px-2 py-0.5 rounded text-sm font-normal">+5</span>
        </button>
    </div>

    <!-- 4. Bids History -->
    <div class="p-4 space-y-4 bg-black pb-12">
        <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-wider border-b border-zinc-800 pb-2 mb-3">Ostatnie oferty</h3>
        <div id="mobile-bids-list" class="space-y-3"></div>
        <div class="pt-6">
            <button onclick="alert('Chat mobilny wkrótce')" class="w-full py-3 bg-zinc-900 border border-zinc-800 rounded-xl text-zinc-400 text-sm font-medium flex items-center justify-center gap-2">
                <i data-lucide="message-circle" class="w-4 h-4"></i>
                Otwórz czat (Wkrótce)
            </button>
        </div>
        <div class="h-20"></div>
    </div>
</div>

<!-- ========================================== -->
<!-- DESKTOP LAYOUT (Grid, Fixed, 3D)           -->
<!-- ========================================== -->
<div class="hidden lg:flex flex-col container mx-auto px-4 py-4 h-full max-w-[1800px]">
  <header class="mb-4 flex items-center justify-between gap-4">
    <div class="flex items-center gap-4">
        <a href="/auctions" class="p-2 bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-400 hover:text-white hover:bg-zinc-800 transition-colors">
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
        </a>
        <div>
            <h1 class="text-xl font-bold text-white tracking-tight leading-none" id="auction-title">Ładowanie...</h1>
            <p class="text-xs text-zinc-500 mt-1" id="auction-subtitle"></p>
        </div>
    </div>
    <div class="flex items-center gap-4">
        <button id="sound-toggle" class="p-2 rounded-lg text-zinc-400 hover:text-white bg-zinc-900 border border-zinc-800 hover:bg-zinc-800 transition-colors"><i data-lucide="volume-2" class="w-5 h-5"></i></button>
        <div class="bg-zinc-900 border border-zinc-800 px-6 py-2 rounded-xl flex flex-col items-center min-w-[140px]">
            <span class="text-[10px] text-zinc-500 uppercase font-bold tracking-wider">Koniec za</span>
            <span class="text-2xl font-bold text-amber-400 font-mono time-badge leading-none" id="main-timer">...</span>
        </div>
    </div>
  </header>

  <div id="auction-content" class="auction-layout hidden">
    <!-- LEFT: Bids -->
    <div class="panel shadow-xl">
        <div class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950/50 backdrop-blur-sm">
            <h3 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="history" class="w-4 h-4 text-emerald-400"></i>Oferty</h3>
            <span class="text-xs font-mono bg-zinc-800 text-zinc-400 px-2 py-0.5 rounded" id="bid-count-badge">0</span>
        </div>
        <div class="flex-1 overflow-y-auto p-3 space-y-2 bg-zinc-950/30" id="bids-list"></div>
    </div>

    <!-- CENTER: Card -->
    <div class="flex flex-col gap-6 items-center justify-center h-full relative">
        <div id="desktop-card-wrapper" class="zinc-card-wrapper w-full">
          <div class="card interactive w-full h-full" id="pokemon-card-desktop">
            <div class="card__translater">
              <div class="card__rotator" id="card-rotator-desktop">
                <div class="card__front">
                  <img id="auction-image" class="w-full h-full object-contain rounded-xl shadow-2xl" src="/static/img/box.png" onerror="this.src='https://placehold.co/400x600/18181b/27272a?text=No+Image'"/>
                  <div class="card__shine"></div>
                  <div class="card__glare"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="w-full max-w-md space-y-4 text-center z-10">
            <div class="flex flex-col items-center bg-zinc-900/80 backdrop-blur-md border border-zinc-800 p-4 rounded-2xl shadow-2xl" id="price-container">
                <p class="text-xs text-zinc-500 uppercase tracking-widest mb-1">Aktualna cena</p>
                <div class="text-5xl font-bold text-emerald-400 font-mono tracking-tighter" id="current-price">0.00 <span class="text-xl text-emerald-600">PLN</span></div>
            </div>
            <button id="place-bid-btn" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold text-lg rounded-xl shadow-xl transition-all active:scale-95 flex items-center justify-center gap-3 border border-white/10 hover:shadow-indigo-500/40">
                <i data-lucide="gavel" class="w-6 h-6"></i>
                Podbij <span id="min-increment-hint" class="text-sm font-normal opacity-80 bg-black/20 px-2 py-0.5 rounded ml-2">+5</span>
            </button>
        </div>
    </div>

    <!-- RIGHT: Chat -->
    <div class="panel shadow-xl">
        <div class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950/50">
            <h3 class="text-sm font-bold text-white flex items-center gap-2"><i data-lucide="message-circle" class="w-4 h-4 text-blue-400"></i>Czat</h3>
            <span class="text-[10px] text-zinc-500 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> LIVE</span>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-zinc-950/30 scroll-smooth" id="chat-messages"></div>
        <div class="p-3 border-t border-zinc-800 bg-zinc-900">
            <form id="chat-form" class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Napisz..." required class="flex-1 bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-2 text-white text-sm outline-none focus:border-indigo-500 transition-colors">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white p-2 rounded-xl transition-colors flex items-center justify-center"><i data-lucide="send" class="w-4 h-4"></i></button>
            </form>
        </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="bid-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4"><div id="bid-modal-content" class="bg-zinc-900 border border-zinc-800 rounded-2xl w-full max-w-md p-6"><h2 class="text-white text-lg font-bold mb-4">Licytuj</h2><form id="bid-form" class="space-y-4"><input type="number" id="bid-amount" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-white" required><button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl">Złóż Ofertę</button></form><div id="bid-msg" class="mt-4 text-center text-sm"></div><button class="close-button mt-4 w-full text-zinc-500">Anuluj</button></div></div>
<div id="login-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4"><div id="login-modal-content" class="bg-zinc-900 border border-zinc-800 rounded-2xl w-full max-w-md p-6"><h2 class="text-white text-lg font-bold mb-4">Zaloguj</h2><form id="login-form" class="space-y-4"><input type="text" id="login-username" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-white" placeholder="Login"><input type="password" id="login-password" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-white" placeholder="Hasło"><button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl">Zaloguj</button></form><div id="login-msg" class="mt-4 text-center text-sm"></div><button class="close-button mt-4 w-full text-zinc-500">Anuluj</button></div></div>
<div id="winner-modal" class="fixed inset-0 z-[100] hidden bg-black/90 backdrop-blur-md flex items-center justify-center p-4"><div class="bg-zinc-900 border border-zinc-800 rounded-3xl w-full max-w-sm p-8 text-center"><h2 class="text-2xl font-bold text-white mb-4">Koniec!</h2><p class="text-zinc-400 mb-6">Wygrał: <span id="winner-name" class="text-white font-bold"></span> za <span id="winner-price" class="text-emerald-400 font-bold"></span></p><div id="participation-msg" class="hidden text-xs text-indigo-400 mb-6">Brałeś udział.</div><a href="/auctions" class="block w-full py-3 bg-zinc-100 text-zinc-900 font-bold rounded-xl">Wróć</a></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_BASE = `http://${window.location.hostname}:8000/auctions`;
    const AUCTION_ID = {{ auction_id }};
    const USER_ID = {{ user_id or 'null' }};
    const USERNAME = "{{ username or '' }}";

    let currentAuctionData = null;
    let lastBidCount = 0;
    let soundEnabled = true;
    let didParticipate = false;
    const bidSound = document.getElementById('bid-sound');

    // UI Elements
    const placeBtn = document.getElementById('place-bid-btn');
    const mobBtn = document.getElementById('mobile-bid-btn');
    const loginForm = document.getElementById('login-form');
    const bidForm = document.getElementById('bid-form');
    const soundToggle = document.getElementById('sound-toggle');

    if(soundToggle) {
        soundToggle.addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            soundToggle.className = `p-2 rounded-lg transition-colors border border-zinc-800 ${soundEnabled ? 'text-zinc-400 hover:text-white bg-zinc-900' : 'text-red-400 bg-red-500/10 border-red-500/20'}`;
        });
    }

    if(placeBtn) placeBtn.onclick = () => openBid(AUCTION_ID, currentAuctionData.current_price, currentAuctionData.min_increment);
    if(mobBtn) mobBtn.onclick = () => openBid(AUCTION_ID, currentAuctionData.current_price, currentAuctionData.min_increment);

    async function loadAuction() {
        try {
            const res = await fetch(`${API_BASE}/${AUCTION_ID}`);
            if (!res.ok) throw new Error('Failed');
            const data = await res.json();
            
            if (currentAuctionData && data.bid_count > lastBidCount) handleNewBid();
            currentAuctionData = data;
            lastBidCount = data.bid_count;
            if (USER_ID && data.bids.some(b => b.kartoteka_user_id === USER_ID)) didParticipate = true;
            if (data.status !== 'active') showWinnerModal(data);
            renderAuction(data);
        } catch (e) { console.error(e); }
    }

    function handleNewBid() {
        const el = document.getElementById('price-container');
        if(el) { el.classList.remove('flash-animate'); void el.offsetWidth; el.classList.add('flash-animate'); }
        if (soundEnabled && bidSound) { bidSound.currentTime = 0; bidSound.play().catch(e=>{}); }
    }

    function renderAuction(data) {
        document.getElementById('loading-spinner').classList.add('hidden');
        if(document.getElementById('auction-content')) document.getElementById('auction-content').classList.remove('hidden');
        if(document.getElementById('mobile-view-container')) document.getElementById('mobile-view-container').style.display = 'flex';
        
        const els = {
            title: document.getElementById('auction-title'),
            subtitle: document.getElementById('auction-subtitle'),
            image: document.getElementById('auction-image'),
            mobImage: document.getElementById('auction-image-mobile'),
            price: document.getElementById('current-price'),
            mobPrice: document.getElementById('mobile-price'),
            timer: document.getElementById('main-timer'),
            mobTimer: document.getElementById('mobile-timer'),
            minInc: document.getElementById('min-increment-hint'),
            mobMinInc: document.getElementById('mobile-increment-hint')
        };
        
        if(els.title) els.title.textContent = data.title;
        if (els.subtitle) els.subtitle.textContent = data.card_name || '';
        const imgUrl = data.image_url || '/static/img/box.png';
        if(els.image) els.image.src = imgUrl;
        if(els.mobImage) els.mobImage.src = imgUrl;
        
        const priceHtml = `${data.current_price.toFixed(2)} <span class="text-base text-emerald-600 align-top">PLN</span>`;
        if(els.price) els.price.innerHTML = priceHtml;
        if(els.mobPrice) els.mobPrice.innerHTML = `${data.current_price.toFixed(2)} PLN`;
        
        if(els.minInc) els.minInc.textContent = `+${data.min_increment} PLN`;
        if(els.mobMinInc) els.mobMinInc.textContent = `+${data.min_increment}`;
        
        startTimer(data.time_remaining);
        renderBids(data.bids);
        renderMessages(data.messages, new Set(data.bids.map(b => b.kartoteka_user_id)));
        if (window.lucide) lucide.createIcons();
    }

    function renderBids(bids) {
        const dList = document.getElementById('bids-list');
        if (dList) {
            dList.innerHTML = '';
            document.getElementById('bid-count-badge').textContent = bids ? bids.length : 0;
            if (!bids || !bids.length) dList.innerHTML = '<div class="text-center text-zinc-500 py-4 text-sm">Brak ofert.</div>';
            else {
                bids.forEach((bid, idx) => {
                    const el = document.createElement('div');
                    el.className = `flex justify-between items-center p-3 rounded-lg border mb-2 ${idx===0 ? 'bg-emerald-900/20 border-emerald-500/30' : 'bg-zinc-900 border-zinc-800'}`;
                    el.innerHTML = `<div class="text-white text-sm font-bold">${bid.username || 'User'}</div><div class="text-emerald-400 font-mono">${bid.amount}</div>`;
                    dList.appendChild(el);
                });
            }
        }
        const mList = document.getElementById('mobile-bids-list');
        if (mList) {
            mList.innerHTML = '';
            if (bids && bids.length > 0) {
                bids.forEach((bid, idx) => {
                    const el = document.createElement('div');
                    el.className = `flex justify-between items-center p-3 rounded-xl border ${idx===0 ? 'bg-emerald-500/10 border-emerald-500/30' : 'bg-zinc-900 border-zinc-800'}`;
                    el.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center text-xs font-bold">${(bid.username||'U')[0].toUpperCase()}</div><div><div class="text-white text-sm font-bold">${bid.username || 'User'}</div><div class="text-zinc-500 text-[10px]">${new Date(bid.timestamp).toLocaleTimeString()}</div></div></div><div class="text-emerald-400 font-mono font-bold">${bid.amount}</div>`;
                    mList.appendChild(el);
                });
            } else {
                mList.innerHTML = '<div class="text-center text-zinc-600 py-4 text-sm">Brak ofert. Bądź pierwszy!</div>';
            }
        }
    }

    function renderMessages(messages, ids) { 
        const list = document.getElementById('chat-messages');
        if(!list) return;
        list.innerHTML = '';
        if(!messages) return;
        [...messages].reverse().forEach(msg => {
            const isMe = msg.kartoteka_user_id === USER_ID;
            const el = document.createElement('div');
            el.className = `flex flex-col mb-3 ${isMe ? 'items-end' : 'items-start'}`;
            el.innerHTML = `<div class="max-w-[85%] rounded-xl px-3 py-2 text-xs ${isMe ? 'bg-indigo-600 text-white' : 'bg-zinc-800 text-zinc-300'}">${msg.message}</div>`;
            list.appendChild(el);
        });
    }

    function showWinnerModal(data) {
        const modal = document.getElementById('winner-modal');
        if (modal.classList.contains('hidden') === false) return;
        const winner = data.bids && data.bids.length > 0 ? data.bids[0].username : 'Nikt';
        const price = data.current_price.toFixed(2);
        document.getElementById('winner-name').textContent = winner;
        document.getElementById('winner-price').textContent = `${price} PLN`;
        if (didParticipate) document.getElementById('participation-msg').classList.remove('hidden');
        modal.classList.remove('hidden');
    }

    function startTimer(seconds) {
        const d = document.getElementById('main-timer');
        const m = document.getElementById('mobile-timer');
        if (window.auctionTimer) clearInterval(window.auctionTimer);
        const update = () => {
            if (seconds <= 0) {
                if(d) d.textContent = "KONIEC"; 
                if(m) m.textContent = "KONIEC";
                return;
            }
            const h = Math.floor(seconds / 3600);
            const mn = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            const txt = `${h>0?h+'h ':''}${mn}m ${s}s`;
            if(d) d.textContent = txt; 
            if(m) m.textContent = txt;
            seconds--;
        };
        update();
        window.auctionTimer = setInterval(update, 1000);
    }

    // Modal functions
    window.openBid = function(id, price, inc) {
        if (!USER_ID || USER_ID === 'null') { openLoginModal(); return; }
        document.getElementById('bid-modal').classList.remove('hidden');
        document.getElementById('modal-price').textContent = price.toFixed(2) + " PLN";
        document.getElementById('bid-amount').value = price + inc;
        document.getElementById('modal-min-bid').textContent = (price + inc).toFixed(2);
    }
    window.openLoginModal = function() { document.getElementById('login-modal').classList.remove('hidden'); }
    document.querySelectorAll('.close-button').forEach(btn => btn.onclick = () => {
        document.getElementById('bid-modal').classList.add('hidden');
        document.getElementById('login-modal').classList.add('hidden');
    });

    if(bidForm) {
        bidForm.onsubmit = async (e) => {
            e.preventDefault();
            const amount = document.getElementById('bid-amount').value;
            try {
                 await fetch(`${API_BASE}/${AUCTION_ID}/bids`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ amount: parseFloat(amount), kartoteka_user_id: USER_ID, username: USERNAME }) });
                 document.getElementById('bid-modal').classList.add('hidden');
                 loadAuction();
            } catch(err) { alert("Błąd: " + err); }
        };
    }

    if(loginForm) {
        loginForm.onsubmit = async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            try {
                const res = await fetch('/users/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username, password}) });
                if (!res.ok) throw new Error((await res.json()).detail);
                window.location.reload();
            } catch (err) {
                document.getElementById('login-msg').textContent = err.message;
                document.getElementById('login-msg').className = 'p-3 rounded-lg text-sm text-center font-medium bg-red-500/10 text-red-400 block';
            }
        };
    }

    // 3D Logic Desktop
    if (!window.matchMedia("(max-width: 1024px)").matches) {
        const wrapper = document.getElementById('desktop-card-wrapper');
        const card = document.getElementById('pokemon-card-desktop');
        if (wrapper && card) {
            wrapper.addEventListener('mousemove', (e) => {
                requestAnimationFrame(() => {
                    const rect = wrapper.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const px = Math.min(Math.max((x / rect.width) * 100, 0), 100);
                    const py = Math.min(Math.max((y / rect.height) * 100, 0), 100);
                    card.style.setProperty('--rotate-x', `${-(py-50)/3.5}deg`);
                    card.style.setProperty('--rotate-y', `${(px-50)/2}deg`);
                    card.style.setProperty('--card-opacity', '1');
                    card.style.setProperty('--background-x', `${50+(px-50)*0.2}%`);
                    card.style.setProperty('--background-y', `${50+(py-50)*0.2}%`);
                    card.style.setProperty('--pointer-x', `${px}%`);
                    card.style.setProperty('--pointer-y', `${py}%`);
                });
            });
            wrapper.addEventListener('mouseleave', () => {
                card.style.setProperty('--rotate-x', '0deg');
                card.style.setProperty('--rotate-y', '0deg');
                card.style.setProperty('--card-opacity', '0');
            });
        }
    }

    loadAuction();
    setInterval(loadAuction, 3000);
});
</script>
{% endblock %}
