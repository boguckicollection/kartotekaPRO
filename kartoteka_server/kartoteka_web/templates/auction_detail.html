{% extends "base.html" %}

{% block title %}Szczegóły Aukcji - Kartoteka{% endblock %}

{% block head_extra %}
<style>
    /* Mobile Immersive Overrides */
    @media (max-width: 1024px) {
        body > header, body > nav, body > footer {
            display: none !important;
        }
        main {
            padding-bottom: 0 !important;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            padding: 0 !important;
            max-width: none !important;
        }
    }

    /* Desktop Layout */
    .auction-layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    @media (min-width: 1024px) {
        .auction-layout {
            grid-template-columns: 350px 1fr 350px;
            gap: 24px;
            height: calc(100vh - 120px);
        }
        main { height: auto; overflow: visible; }
    }

    /* Card Styling */
    .zinc-card-wrapper {
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        aspect-ratio: 3/4;
        position: relative;
        max-width: 450px;
        margin: 0 auto;
        touch-action: none;
        perspective: 1000px;
    }
    
    .panel {
        background: #18181b;
        border: 1px solid #27272a;
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100%;
        max-height: 500px;
    }
    
    @media (min-width: 1280px) {
        .panel { max-height: none; }
    }

    @keyframes flash-green {
        0% { background-color: rgba(16, 185, 129, 0.4); }
        100% { background-color: transparent; }
    }
    .flash-animate { animation: flash-green 0.8s ease-out; }
    
    .time-badge { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }

    /* Mobile Overlay */
    .mobile-bids-overlay {
        background: linear-gradient(to top, #000000 80%, transparent 100%);
        pointer-events: none;
        padding-top: 40px; /* Fade area */
    }
    .mobile-bids-overlay > * { pointer-events: auto; }

    .bg-radial-gradient {
        background: radial-gradient(circle at center, #27272a 0%, #09090b 80%, #000000 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="h-full w-full flex flex-col lg:container lg:mx-auto lg:px-4 lg:py-4 relative bg-black lg:bg-transparent">
  
  <audio id="bid-sound" src="{{ url_for('static', path='/sounds/bit.mp3') }}" preload="auto"></audio>

  <!-- === MOBILE HEADER (Custom) === -->
  <div class="lg:hidden absolute top-0 left-0 right-0 z-30 p-4 flex justify-between items-start pointer-events-none h-24">
      <a href="/auctions" class="pointer-events-auto p-2.5 bg-black/40 backdrop-blur-md border border-white/10 rounded-full text-white active:scale-95 transition-transform shadow-lg">
          <i data-lucide="arrow-left" class="w-6 h-6"></i>
      </a>
      
      <div class="pointer-events-auto flex flex-col items-end gap-2">
          <div class="px-3 py-1.5 bg-black/60 backdrop-blur-md border border-white/10 rounded-full flex items-center gap-2 shadow-lg">
              <span class="text-[10px] uppercase font-bold text-zinc-400 tracking-wider">Koniec za</span>
              <span class="text-sm font-bold text-amber-400 font-mono leading-none" id="mobile-timer">...</span>
          </div>
          <div class="px-3 py-1.5 bg-black/60 backdrop-blur-md border border-white/10 rounded-full shadow-lg">
              <span class="text-lg font-bold text-emerald-400 font-mono leading-none" id="mobile-price">...</span>
          </div>
      </div>
  </div>

  <!-- === DESKTOP HEADER === -->
  <header class="hidden lg:flex mb-4 items-center justify-between gap-4">
    <div class="flex items-center gap-4">
        <a href="/auctions" class="p-2 bg-zinc-900 border border-zinc-800 rounded-lg text-zinc-400 hover:text-white hover:bg-zinc-800 transition-colors">
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
        </a>
        <div>
            <h1 class="text-xl font-bold text-white tracking-tight leading-none" id="auction-title">Ładowanie...</h1>
            <p class="text-xs text-zinc-500 mt-1" id="auction-subtitle"></p>
        </div>
    </div>
    
    <div class="flex items-center gap-4">
        <button id="sound-toggle" class="p-2 rounded-lg text-zinc-400 hover:text-white bg-zinc-900 border border-zinc-800 hover:bg-zinc-800 transition-colors" title="Włącz/Wyłącz dźwięk">
            <i data-lucide="volume-2" class="w-5 h-5"></i>
        </button>
        <div class="bg-zinc-900 border border-zinc-800 px-6 py-2 rounded-xl flex flex-col items-center min-w-[140px]">
            <span class="text-[10px] text-zinc-500 uppercase font-bold tracking-wider">Koniec za</span>
            <span class="text-2xl font-bold text-amber-400 font-mono time-badge leading-none" id="main-timer">...</span>
        </div>
    </div>
  </header>

  <!-- === MAIN CONTENT === -->
  <div id="loading-spinner" class="flex justify-center py-20 lg:hidden">
      <span class="loading loading-spinner loading-lg text-indigo-500"></span>
  </div>

  <div id="auction-content" class="flex-1 min-h-0 relative lg:grid lg:grid-cols-[350px_1fr_350px] lg:gap-6 hidden">
    
    <!-- LEFT PANEL (Desktop Only - Bids) -->
    <div class="panel shadow-xl hidden lg:flex">
        <div class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950/50 backdrop-blur-sm">
            <h3 class="text-sm font-bold text-white flex items-center gap-2">
                <i data-lucide="history" class="w-4 h-4 text-emerald-400"></i>
                Oferty na żywo
            </h3>
            <span class="text-xs font-mono bg-zinc-800 text-zinc-400 px-2 py-0.5 rounded" id="bid-count-badge">0</span>
        </div>
        <div class="flex-1 overflow-y-auto p-3 space-y-2 bg-zinc-950/30" id="bids-list"></div>
    </div>

    <!-- CENTER / MOBILE MAIN (Card) -->
    <div class="absolute top-20 bottom-48 left-0 right-0 lg:static lg:inset-auto flex flex-col items-center justify-center z-0 overflow-hidden bg-radial-gradient">
        <!-- 3D Card Container -->
        <div id="card-wrapper" class="zinc-card-wrapper w-full h-full max-h-full lg:max-h-[65vh] flex items-center justify-center p-4">
          <div class="card interactive w-full h-full max-w-[90vw] lg:max-w-full" id="pokemon-card">
            <div class="card__translater">
              <div class="card__rotator" id="card-rotator">
                <div class="card__front">
                  <img id="auction-image" alt="Podgląd karty" class="w-full h-full object-contain rounded-xl shadow-2xl" />
                  <div class="card__shine"></div>
                  <div class="card__glare"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Desktop Info (Hidden on Mobile) -->
        <div class="hidden lg:block w-full max-w-lg space-y-4 text-center z-10 mt-6">
            <div class="flex flex-col items-center bg-zinc-900/80 backdrop-blur-md border border-zinc-800 p-4 rounded-2xl shadow-2xl" id="price-container">
                <p class="text-xs text-zinc-500 uppercase tracking-widest mb-1">Aktualna cena</p>
                <div class="text-6xl font-bold text-emerald-400 font-mono tracking-tighter leading-none filter drop-shadow-lg" id="current-price">0.00 <span class="text-2xl text-emerald-600 align-top mt-2 inline-block">PLN</span></div>
            </div>
            <button id="place-bid-btn" class="w-full py-5 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-bold text-xl rounded-2xl shadow-xl shadow-indigo-500/20 transition-all active:scale-[0.98] flex items-center justify-center gap-3 border border-white/10 hover:shadow-indigo-500/40">
                <i data-lucide="gavel" class="w-7 h-7"></i>
                Podbij <span id="min-increment-hint" class="text-sm font-normal opacity-80 bg-black/20 px-2 py-0.5 rounded ml-2">+5 PLN</span>
            </button>
        </div>
    </div>

    <!-- RIGHT PANEL (Desktop Only - Chat) -->
    <div class="panel shadow-xl hidden lg:flex">
        <div class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-950/50 backdrop-blur-sm">
            <h3 class="text-sm font-bold text-white flex items-center gap-2">
                <i data-lucide="message-circle" class="w-4 h-4 text-blue-400"></i>
                Czat
            </h3>
            <span class="text-[10px] text-zinc-500 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> LIVE</span>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-zinc-950/30 scroll-smooth" id="chat-messages"></div>
        <div class="p-3 border-t border-zinc-800 bg-zinc-900">
            <form id="chat-form" class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Napisz..." required class="flex-1 bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-2.5 text-white text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-colors">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white p-2.5 rounded-xl transition-colors flex items-center justify-center">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- === MOBILE BOTTOM OVERLAY === -->
    <div class="lg:hidden absolute bottom-0 left-0 right-0 z-30 flex flex-col justify-end mobile-bids-overlay">
        <div class="px-4 pb-6 w-full max-w-md mx-auto bg-transparent">
            <!-- Latest Bids (Mobile) -->
            <div id="mobile-bids-preview" class="space-y-2 mb-4 max-h-[120px] overflow-y-auto no-scrollbar"></div>
            
            <!-- Action Button -->
            <button id="mobile-bid-btn" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-violet-600 text-white font-bold text-lg rounded-2xl shadow-xl shadow-indigo-900/40 active:scale-95 transition-transform flex items-center justify-center gap-2 border border-white/10">
                <i data-lucide="gavel" class="w-6 h-6"></i>
                Podbij <span id="mobile-increment-hint" class="text-sm font-normal opacity-80 bg-black/20 px-2 py-0.5 rounded ml-1">+5</span>
            </button>
            
            <!-- Bottom Link -->
            <div class="text-center mt-4 flex justify-center gap-4">
                <a href="/auctions" class="text-xs text-zinc-400 hover:text-white font-medium py-2 px-4 rounded-full bg-white/10 backdrop-blur border border-white/5">
                    Wróć
                </a>
                <button onclick="toggleMobileChat()" class="text-xs text-zinc-400 hover:text-white font-medium py-2 px-4 rounded-full bg-white/10 backdrop-blur border border-white/5 flex items-center gap-1">
                    <i data-lucide="message-circle" class="w-3 h-3"></i> Czat
                </button>
            </div>
        </div>
    </div>

  </div>
</div>

<!-- Winner Modal -->
<div id="winner-modal" class="fixed inset-0 z-[100] hidden bg-black/90 backdrop-blur-md flex items-center justify-center p-4 opacity-0 transition-opacity duration-500" aria-hidden="true">
    <div class="bg-zinc-900 border border-zinc-800 rounded-3xl w-full max-w-sm shadow-2xl transform scale-90 transition-transform duration-500 p-8 text-center relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-b from-indigo-500/10 to-transparent pointer-events-none"></div>
        <div class="w-20 h-20 bg-amber-400/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-amber-400/40 animate-bounce">
            <i data-lucide="trophy" class="w-10 h-10 text-amber-400"></i>
        </div>
        <h2 class="text-2xl font-bold text-white mb-1">Aukcja Zakończona!</h2>
        <p class="text-zinc-400 text-sm mb-6">Gratulacje dla zwycięzcy</p>
        <div class="bg-black/40 rounded-2xl p-4 border border-white/5 mb-6">
            <div class="text-xs text-zinc-500 uppercase font-bold mb-1">Zwycięzca</div>
            <div class="text-xl font-bold text-white mb-3" id="winner-name">---</div>
            <div class="text-xs text-zinc-500 uppercase font-bold mb-1">Kwota końcowa</div>
            <div class="text-3xl font-bold text-emerald-400 font-mono" id="winner-price">---</div>
        </div>
        <div id="participation-msg" class="hidden text-xs text-indigo-400 bg-indigo-500/10 p-3 rounded-lg border border-indigo-500/20 mb-6">
            Brałeś udział w tej licytacji. Została zapisana w Twojej historii.
        </div>
        <a href="/auctions" class="block w-full py-3.5 bg-zinc-100 hover:bg-white text-zinc-900 font-bold rounded-xl transition-colors">Wróć do listy</a>
    </div>
</div>

<!-- Existing Bid/Login Modals -->
<div id="bid-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
  <div class="bg-zinc-900 border border-zinc-800 rounded-2xl w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300" id="bid-modal-content">
    <div class="flex justify-between items-center p-5 border-b border-zinc-800">
      <h2 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="zap" class="w-5 h-5 text-amber-400"></i> Licytuj</h2>
      <button class="close-button text-zinc-400 hover:text-white p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>
    <div class="p-6 space-y-4">
      <div class="flex justify-between items-center bg-zinc-950 p-4 rounded-xl border border-zinc-800">
        <span class="text-zinc-400 text-sm">Cena</span> <span id="modal-price" class="text-2xl font-bold text-emerald-400 font-mono">0.00 PLN</span>
      </div>
      <form id="bid-form" class="space-y-4">
        <input type="number" id="bid-amount" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-white text-lg font-mono focus:border-indigo-500 outline-none" placeholder="0.00" required>
        <p class="text-xs text-zinc-500">Min: <span id="modal-min-bid" class="font-bold">0.00</span> PLN</p>
        <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl">Złóż Ofertę</button>
      </form>
      <div id="bid-msg" class="hidden p-3 rounded-lg text-sm text-center"></div>
    </div>
  </div>
</div>

<div id="login-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
  <div class="bg-zinc-900 border border-zinc-800 rounded-2xl w-full max-w-md shadow-2xl transform scale-95 transition-transform duration-300" id="login-modal-content">
    <div class="p-6 space-y-4">
      <h2 class="text-lg font-bold text-white text-center">Zaloguj się</h2>
      <form id="login-form" class="space-y-4">
        <input type="text" id="login-username" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-white" placeholder="Login" required>
        <input type="password" id="login-password" class="w-full bg-zinc-950 border border-zinc-800 rounded-xl px-4 py-3 text-white" placeholder="Hasło" required>
        <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl">Zaloguj</button>
      </form>
      <div id="login-msg" class="hidden p-3 rounded-lg text-sm text-center"></div>
      <button class="close-button w-full py-2 text-zinc-500 text-sm">Anuluj</button>
    </div>
  </div>
</div>

<script>
const API_BASE = `http://${window.location.hostname}:8000/auctions`;
const AUCTION_ID = {{ auction_id }};
const USER_ID = {{ user_id or 'null' }};
const USERNAME = "{{ username or '' }}";

let currentAuctionData = null;
let lastBidCount = 0;
let soundEnabled = true;
let didParticipate = false;
const bidSound = document.getElementById('bid-sound');

// Sound Toggle
const soundToggle = document.getElementById('sound-toggle');
soundToggle.addEventListener('click', () => {
    soundEnabled = !soundEnabled;
    soundToggle.innerHTML = soundEnabled ? '<i data-lucide="volume-2" class="w-5 h-5"></i>' : '<i data-lucide="volume-x" class="w-5 h-5"></i>';
    soundToggle.className = `p-2 rounded-lg transition-colors border border-zinc-800 ${soundEnabled ? 'text-zinc-400 hover:text-white bg-zinc-900' : 'text-red-400 bg-red-500/10 border-red-500/20'}`;
    if(window.lucide) lucide.createIcons();
});

async function loadAuction() {
    try {
        const res = await fetch(`${API_BASE}/${AUCTION_ID}`);
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        
        if (currentAuctionData && data.bid_count > lastBidCount) handleNewBid();
        
        currentAuctionData = data;
        lastBidCount = data.bid_count;
        
        if (USER_ID && data.bids.some(b => b.kartoteka_user_id === USER_ID)) didParticipate = true;
        
        if (data.status !== 'active') showWinnerModal(data);
        
        renderAuction(data);
    } catch (e) { console.error(e); }
}

function handleNewBid() {
    const el = document.getElementById('price-container');
    if(el) { el.classList.remove('flash-animate'); void el.offsetWidth; el.classList.add('flash-animate'); }
    const elMob = document.getElementById('mobile-price')?.parentElement;
    if(elMob) { elMob.classList.add('bg-emerald-500/50'); setTimeout(() => elMob.classList.remove('bg-emerald-500/50'), 500); }
    if (soundEnabled && bidSound) { bidSound.currentTime = 0; bidSound.play().catch(e=>{}); }
}

function renderAuction(data) {
    document.getElementById('loading-spinner').classList.add('hidden');
    document.getElementById('auction-content').classList.remove('hidden');
    
    const els = {
        title: document.getElementById('auction-title'),
        subtitle: document.getElementById('auction-subtitle'),
        image: document.getElementById('auction-image'),
        price: document.getElementById('current-price'),
        mobPrice: document.getElementById('mobile-price'),
        timer: document.getElementById('main-timer'),
        mobTimer: document.getElementById('mobile-timer'),
        minInc: document.getElementById('min-increment-hint'),
        mobMinInc: document.getElementById('mobile-increment-hint')
    };
    
    els.title.textContent = data.title;
    if (els.subtitle) els.subtitle.textContent = data.card_name || '';
    els.image.src = data.image_url || '/static/img/box.png';
    
    const priceHtml = `${data.current_price.toFixed(2)} <span class="text-base text-emerald-600 align-top">PLN</span>`;
    els.price.innerHTML = priceHtml;
    if (els.mobPrice) els.mobPrice.innerHTML = `${data.current_price.toFixed(2)} PLN`;
    
    els.minInc.textContent = `+${data.min_increment} PLN`;
    if (els.mobMinInc) els.mobMinInc.textContent = `+${data.min_increment}`;
    
    startTimer(data.time_remaining);
    renderBids(data.bids);
    renderMessages(data.messages, new Set(data.bids.map(b => b.kartoteka_user_id)));
    if (window.lucide) lucide.createIcons();
}

function renderBids(bids) {
    // Desktop
    const dList = document.getElementById('bids-list');
    if (dList) {
        dList.innerHTML = '';
        document.getElementById('bid-count-badge').textContent = bids ? bids.length : 0;
        if (!bids || !bids.length) dList.innerHTML = '<div class="text-center text-zinc-500 py-4 text-sm">Brak ofert.</div>';
        else {
            bids.forEach((bid, idx) => {
                const el = document.createElement('div');
                el.className = `flex justify-between items-center p-3 rounded-lg border mb-2 ${idx===0 ? 'bg-emerald-900/20 border-emerald-500/30' : 'bg-zinc-900 border-zinc-800'}`;
                el.innerHTML = `<div class="text-white text-sm font-bold">${bid.username || 'User'}</div><div class="text-emerald-400 font-mono">${bid.amount}</div>`;
                dList.appendChild(el);
            });
        }
    }
    // Mobile
    const mList = document.getElementById('mobile-bids-preview');
    if (mList) {
        mList.innerHTML = '';
        if (bids && bids.length > 0) {
            bids.slice(0, 2).forEach((bid, idx) => {
                const el = document.createElement('div');
                el.className = `flex justify-between items-center p-3 rounded-xl backdrop-blur-md border shadow-sm ${idx===0 ? 'bg-emerald-500/20 border-emerald-500/40 shadow-emerald-500/10' : 'bg-black/60 border-white/10'}`;
                el.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center text-[10px] text-white font-bold">${(bid.username||'U')[0].toUpperCase()}</div>
                        <span class="text-white text-xs font-bold drop-shadow-md">${bid.username || 'User'}</span>
                    </div>
                    <span class="text-white text-sm font-mono font-bold drop-shadow-md">${bid.amount} PLN</span>
                `;
                mList.appendChild(el);
            });
        }
    }
}

function renderMessages(messages, ids) { /* ... */ }

function showWinnerModal(data) {
    const modal = document.getElementById('winner-modal');
    if (modal.classList.contains('hidden') === false) return;
    const winner = data.bids && data.bids.length > 0 ? data.bids[0].username : 'Nikt';
    const price = data.current_price.toFixed(2);
    document.getElementById('winner-name').textContent = winner;
    document.getElementById('winner-price').textContent = `${price} PLN`;
    if (didParticipate) document.getElementById('participation-msg').classList.remove('hidden');
    modal.classList.remove('hidden');
    requestAnimationFrame(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-90'); modal.querySelector('div').classList.add('scale-100'); });
}

function startTimer(seconds) {
    const d = document.getElementById('main-timer');
    const m = document.getElementById('mobile-timer');
    if (window.auctionTimer) clearInterval(window.auctionTimer);
    const update = () => {
        if (seconds <= 0) {
            d.textContent = "KONIEC"; m.textContent = "KONIEC";
            return;
        }
        const h = Math.floor(seconds / 3600);
        const mn = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        const txt = `${h>0?h+'h ':''}${mn}m ${s}s`;
        d.textContent = txt; m.textContent = txt;
        seconds--;
    };
    update();
    window.auctionTimer = setInterval(update, 1000);
}

// 3D Interaction Logic (Fixed for desktop jitter)
document.addEventListener('DOMContentLoaded', () => {
    const card = document.getElementById('pokemon-card');
    const wrapper = document.getElementById('card-wrapper'); // Use wrapper instead of rotator
    const rotator = document.getElementById('card-rotator');
    
    if (!card || !wrapper || !rotator) return;

    const clamp = (val, min, max) => Math.min(Math.max(val, min), max);
    
    const interact = (e) => {
        requestAnimationFrame(() => {
            const rect = wrapper.getBoundingClientRect(); // Rect of stable wrapper
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            const px = clamp((x / rect.width) * 100, 0, 100);
            const py = clamp((y / rect.height) * 100, 0, 100);
            
            const rx = -(py - 50) / 3.5;
            const ry = (px - 50) / 2;

            card.style.setProperty('--pointer-x', `${px}%`);
            card.style.setProperty('--pointer-y', `${py}%`);
            card.style.setProperty('--rotate-x', `${rx}deg`);
            card.style.setProperty('--rotate-y', `${ry}deg`);
            card.style.setProperty('--card-opacity', '1');
            
            const bgx = 50 + (px - 50) * 0.2;
            const bgy = 50 + (py - 50) * 0.2;
            card.style.setProperty('--background-x', `${bgx}%`);
            card.style.setProperty('--background-y', `${bgy}%`);
        });
    };

    const reset = () => {
        card.style.setProperty('--rotate-x', '0deg');
        card.style.setProperty('--rotate-y', '0deg');
        card.style.setProperty('--card-opacity', '0');
    };

    // Events
    if (window.matchMedia("(pointer: coarse)").matches) {
        wrapper.addEventListener('touchmove', (e) => { e.preventDefault(); interact(e); }, { passive: false });
        wrapper.addEventListener('touchend', reset);
    } else {
        wrapper.addEventListener('mousemove', interact);
        wrapper.addEventListener('mouseleave', reset);
    }
});

// ... Modals & Events ...
document.getElementById('place-bid-btn').onclick = () => openBid(AUCTION_ID, currentAuctionData.current_price, currentAuctionData.min_increment);
document.getElementById('mobile-bid-btn').onclick = () => openBid(AUCTION_ID, currentAuctionData.current_price, currentAuctionData.min_increment);

const modal = document.getElementById('bid-modal');
const modalContent = document.getElementById('bid-modal-content');
const form = document.getElementById('bid-form');
const msgDiv = document.getElementById('bid-msg');
const loginModal = document.getElementById('login-modal');
const loginContent = document.getElementById('login-modal-content');
const loginForm = document.getElementById('login-form');
const loginMsg = document.getElementById('login-msg');

function openBid(id, currentPrice, increment) {
    if (!USER_ID || USER_ID === 'null') { openLoginModal(); return; }
    document.getElementById('modal-price').textContent = currentPrice.toFixed(2) + " PLN";
    const minBid = currentPrice + increment;
    document.getElementById('modal-min-bid').textContent = minBid.toFixed(2);
    const bidInput = document.getElementById('bid-amount');
    bidInput.value = minBid; bidInput.min = minBid;
    msgDiv.className = 'hidden'; modal.classList.remove('hidden');
    requestAnimationFrame(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); });
}
function closeModal() { modal.classList.add('opacity-0'); modalContent.classList.remove('scale-100'); modalContent.classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); }, 300); }
function openLoginModal() { loginModal.classList.remove('hidden'); requestAnimationFrame(() => { loginModal.classList.remove('opacity-0'); loginContent.classList.remove('scale-95'); loginContent.classList.add('scale-100'); }); }
function closeLoginModal() { loginModal.classList.add('opacity-0'); loginContent.classList.remove('scale-100'); loginContent.classList.add('scale-95'); setTimeout(() => { loginModal.classList.add('hidden'); }, 300); }
document.querySelectorAll('.close-button').forEach(btn => btn.onclick = () => { closeModal(); closeLoginModal(); });

form.onsubmit = async (e) => {
    e.preventDefault();
    const amount = document.getElementById('bid-amount').value;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true; submitBtn.innerHTML = '...';
    try {
        await fetch(`${API_BASE}/sync-user`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ kartoteka_user_id: USER_ID, username: USERNAME, is_active: true }) });
        const res = await fetch(`${API_BASE}/${AUCTION_ID}/bids`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ amount: parseFloat(amount), kartoteka_user_id: USER_ID, username: USERNAME }) });
        if (!res.ok) throw new Error((await res.json()).detail || 'Błąd');
        msgDiv.textContent = "Sukces!"; msgDiv.className = 'p-3 rounded-lg text-sm text-center font-medium bg-emerald-500/10 text-emerald-400 block';
        setTimeout(() => { closeModal(); loadAuction(); }, 1000);
    } catch (err) {
        msgDiv.textContent = err.message; msgDiv.className = 'p-3 rounded-lg text-sm text-center font-medium bg-red-500/10 text-red-400 block';
        submitBtn.disabled = false; submitBtn.innerHTML = originalText;
    }
};

loginForm.onsubmit = async (e) => {
    e.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    try {
        const res = await fetch('/users/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username, password}) });
        if (!res.ok) throw new Error((await res.json()).detail);
        window.location.reload();
    } catch (err) {
        document.getElementById('login-msg').textContent = err.message;
        document.getElementById('login-msg').className = 'p-3 rounded-lg text-sm text-center font-medium bg-red-500/10 text-red-400 block';
    }
};

loadAuction();
setInterval(loadAuction, 3000);
</script>
{% endblock %}
