{% extends "base.html" %}
{% block title %}Kolekcja - Kartoteka{% endblock %}

{% block head_extra %}
<style>
/* Zinc Dark Dashboard Styles */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}

.stat-card {
  background: #18181b;
  border: 1px solid #27272a;
  border-radius: 8px;
  padding: 12px;
  transition: border-color 0.2s;
}

.stat-card:hover {
  border-color: #3f3f46;
}

.stat-card--highlight {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
  border-color: rgba(99, 102, 241, 0.3);
}

.stat-label {
  font-size: 11px;
  color: #71717a;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 36px;
  font-weight: 600;
  color: #fafafa;
  line-height: 1.2;
}

.stat-breakdown {
  display: flex;
  gap: 12px;
  margin-top: 8px;
  font-size: 11px;
  color: #a1a1aa;
}

.stat-breakdown small {
  color: #71717a;
}

.chart-container {
  height: 300px;
  margin-top: 16px;
  position: relative;
  background: #000000;
  border: 1px solid #27272a;
  border-radius: 8px;
  padding: 16px;
}

/* Chart styling inspired by generated-page2.html */
.chart-container canvas {
  position: relative;
  z-index: 1;
}

/* Vertical crosshair on hover */
.chart-container::after {
  content: '';
  position: absolute;
  top: 0;
  left: var(--crosshair-x, -9999px);
  width: 1px;
  height: 100%;
  background: rgba(99, 102, 241, 0.3);
  pointer-events: none;
  z-index: 2;
  transition: left 0.1s ease;
}

.collections-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
}

.collection-card {
  background: #18181b;
  border: 1px solid #27272a;
  border-radius: 8px;
  overflow: hidden;
  text-decoration: none;
  transition: border-color 0.2s, transform 0.2s;
  display: block;
}

.collection-card:hover {
  border-color: #3f3f46;
  transform: translateY(-2px);
}

.collection-cover {
  aspect-ratio: 16/9;
  background: #27272a;
  display: flex;
  align-items: center;
  justify-content: center;
  background-size: cover;
  background-position: center;
}

.collection-icon {
  font-size: 32px;
}

.collection-info {
  padding: 12px;
}

.collection-type-badge {
  display: inline-block;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #a1a1aa;
  background: #27272a;
  padding: 2px 6px;
  border-radius: 4px;
  margin-bottom: 6px;
}

.collection-name {
  font-size: 13px;
  font-weight: 600;
  color: #fafafa;
  margin: 0 0 4px;
  line-height: 1.3;
}

.collection-subtitle {
  font-size: 11px;
  color: #71717a;
  margin: 0 0 8px;
}

.collection-progress {
  margin-top: 8px;
}

.progress-bar {
  height: 4px;
  background: #27272a;
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 4px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #6366f1, #8b5cf6);
  transition: width 0.3s;
}

.progress-text {
  font-size: 10px;
  color: #71717a;
}

.stats-purchase-details {
  margin-top: 12px;
}

.stats-purchase-details summary {
  cursor: pointer;
  font-size: 12px;
  color: #a1a1aa;
  padding: 8px 12px;
  background: #18181b;
  border: 1px solid #27272a;
  border-radius: 6px;
  transition: background 0.2s;
}

.stats-purchase-details summary:hover {
  background: #27272a;
}

.stats-purchase-details[open] summary {
  margin-bottom: 12px;
}

.stats-grid--secondary {
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
}

.stat-card--small {
  padding: 10px;
}

.stat-card--small .stat-value {
  font-size: 16px;
}

.chart-controls {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.form-control--checkbox {
  display: flex;
  align-items: center;
  gap: 6px;
}

.form-control--checkbox input[type="checkbox"] {
  width: 16px;
  height: 16px;
  cursor: pointer;
}

.form-control--checkbox label {
  font-size: 12px;
  color: #a1a1aa;
  cursor: pointer;
}

.button-group {
  display: inline-flex;
  gap: 4px;
  background: #18181b;
  border: 1px solid #27272a;
  border-radius: 6px;
  padding: 3px;
}

.button-group .button {
  padding: 4px 10px;
  font-size: 11px;
  border: none;
  background: transparent;
  color: #71717a;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.button-group .button:hover {
  color: #fafafa;
  background: #27272a;
}

.button-group .button.is-active {
  background: #fafafa;
  color: #09090b;
  font-weight: 600;
}
</style>
{% endblock %}

{% block content %}

<!-- Compact Hero -->
<section class="bg-zinc-950 pt-8 pb-2">
  <div class="container mx-auto px-4 max-w-6xl">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
      <div>
        <div class="inline-flex items-center px-2 py-1 bg-indigo-500/10 border border-indigo-500/20 rounded text-[10px] font-medium text-indigo-400 uppercase tracking-wider mb-2">
          Twoja kolekcja
        </div>
        <h1 class="text-2xl font-semibold text-white tracking-tight">Witaj, {{ username }}!</h1>
      </div>
      <div class="flex gap-2">
        <a href="/cards/add" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-medium rounded-md transition-colors">
          <i data-lucide="plus-circle" class="w-3.5 h-3.5"></i>
          Dodaj nową kartę
        </a>
        <button type="button" class="inline-flex items-center gap-2 px-4 py-2 bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 text-white text-xs font-medium rounded-md transition-colors" id="new-collection-btn">
          <i data-lucide="folder-plus" class="w-3.5 h-3.5"></i>
          Nowa kolekcja
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Value & Chart Section -->
<section class="bg-zinc-950 border-b border-zinc-800 pb-8 pt-4">
  <div class="container mx-auto px-4 max-w-6xl">
    
    <!-- Value Display -->
    <div class="mb-6">
        <h2 class="text-xs font-medium text-zinc-500 uppercase tracking-wider mb-1">Całkowita wartość portfela</h2>
        <div class="flex items-baseline gap-3">
            <span class="text-5xl md:text-6xl font-bold text-emerald-400 tracking-tighter" id="stat-total-value">0.00 PLN</span>
        </div>
    </div>

    <!-- Chart -->
    <div class="relative">
      <div class="chart-container" style="background: transparent; border: none; padding: 0; margin-top: 0; height: 300px;">
        <canvas id="collection-value-chart"></canvas>
      </div>
      
      <!-- Chart Controls Overlay -->
      <div class="flex justify-end mt-2 gap-4 items-center">
         <div class="form-control form-control--checkbox">
            <input type="checkbox" id="toggle-products-value" checked>
            <label for="toggle-products-value">Produkty</label>
         </div>
         <div class="button-group" id="chart-range-selector">
            <button type="button" class="button" data-range="90d">90D</button>
            <button type="button" class="button" data-range="60d">60D</button>
            <button type="button" class="button is-active" data-range="30d">30D</button>
            <button type="button" class="button" data-range="7d">7D</button>
         </div>
      </div>
    </div>

  </div>
</section>

<!-- Stats Grid Section -->
<section class="py-8 bg-black border-b border-zinc-800">
  <div class="container mx-auto px-4 max-w-6xl">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Liczba kart</div>
        <div class="stat-value" id="stat-total-cards">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Unikalne karty</div>
        <div class="stat-value" id="stat-unique-cards">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Produkty</div>
        <div class="stat-value" id="stat-total-products">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Koszt zakupu</div>
        <div class="stat-value" id="stat-purchase-value">0 PLN</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Zysk/Strata</div>
        <div class="stat-value" id="stat-profit-loss">0 PLN</div>
      </div>
    </div>
    
    <!-- Hidden detailed breakdown for JS compatibility if needed -->
    <span id="stat-cards-value" hidden></span>
    <span id="stat-products-value" hidden></span>
  </div>
</section>

<!-- Collection Cards Section -->
<section class="py-6 bg-black border-b border-zinc-800">
  <div class="container mx-auto px-4 max-w-6xl">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-4">
      <div>
        <h2 class="text-sm font-semibold text-zinc-300 flex items-center gap-2">
          <i data-lucide="layers" class="w-4 h-4 text-purple-400"></i>
          Twoje karty
        </h2>
        <p class="text-xs text-zinc-500 mt-1" id="collection-mode-desc">Przeglądaj informacje o kartach w kolekcji</p>
      </div>
      <div class="button-group">
        <button type="button" class="button is-active" data-view-mode="info" aria-pressed="true">
          Widok kart
        </button>
        <button type="button" class="button" data-view-mode="edit" aria-pressed="false">
          Widok edycji
        </button>
      </div>
    </div>
    <div class="alert bg-zinc-900/50 border border-zinc-800 rounded-lg p-3 text-xs text-zinc-400" id="collection-alert" hidden></div>
    <div class="card-search-results card-search-results--grid" id="collection-cards" role="list" data-collection-mode="info"></div>
    <p class="text-center text-sm text-zinc-500 py-8 bg-zinc-900/30 border border-zinc-800 rounded-lg" id="collection-empty" hidden>
      Brak kart w kolekcji. Dodaj karty klikając "Dodaj nową kartę" powyżej.
    </p>
  </div>
</section>

<!-- My Collections Section -->
<section class="py-6 bg-zinc-950">
  <div class="container mx-auto px-4 max-w-6xl">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h2 class="text-sm font-semibold text-zinc-300 flex items-center gap-2">
          <i data-lucide="folder-open" class="w-4 h-4 text-yellow-400"></i>
          Moje Kolekcje
        </h2>
        <p class="text-xs text-zinc-500 mt-1">Śledź postęp kompletowania setów i kolekcji artystów</p>
      </div>
      <a href="/my-collections" class="text-xs text-indigo-400 hover:text-indigo-300 transition-colors">
        Zobacz wszystkie →
      </a>
    </div>
    <div class="collections-grid" id="user-collections-grid">
      <!-- Collections will be loaded here via JavaScript -->
    </div>
    <div class="text-center py-4" id="collections-loading" hidden>
      <div class="inline-block animate-spin rounded-full h-6 w-6 border-2 border-zinc-700 border-t-indigo-500"></div>
    </div>
    <p class="text-center text-sm text-zinc-500 py-8 bg-zinc-900/30 border border-zinc-800 rounded-lg" id="collections-empty" hidden>
      Brak kolekcji. Kliknij "Nowa kolekcja" aby utworzyć pierwszą.
    </p>
  </div>
</section>

<!-- New Collection Modal -->
<div class="modal-overlay" id="new-collection-modal" hidden>
  <div class="modal">
    <div class="modal-header">
      <h2>Nowa Kolekcja</h2>
      <button type="button" class="modal-close" data-close-modal>&times;</button>
    </div>
    <div class="modal-body">
      <form id="new-collection-form">
        <div class="form-group">
          <label>Typ kolekcji</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" name="collection_type" value="custom" checked />
              <span class="radio-label">
                <span class="radio-icon">&#9733;</span>
                <span class="radio-text">
                  <strong>Własna kolekcja</strong>
                  <small>Dodawaj dowolne karty ręcznie</small>
                </span>
              </span>
            </label>
            <label class="radio-option">
              <input type="radio" name="collection_type" value="set" />
              <span class="radio-label">
                <span class="radio-icon">&#128230;</span>
                <span class="radio-text">
                  <strong>Cały set Pokemon</strong>
                  <small>Zbieraj kompletny set kart</small>
                </span>
              </span>
            </label>
            <label class="radio-option">
              <input type="radio" name="collection_type" value="artist" />
              <span class="radio-label">
                <span class="radio-icon">&#127912;</span>
                <span class="radio-text">
                  <strong>Karty artysty</strong>
                  <small>Zbieraj prace ulubionego artysty</small>
                </span>
              </span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="collection-name">Nazwa kolekcji</label>
          <input type="text" id="collection-name" name="name" required placeholder="np. Moja kolekcja SV" />
        </div>
        
        <div class="form-group">
          <label for="collection-description">Opis (opcjonalnie)</label>
          <textarea id="collection-description" name="description" rows="2" placeholder="Krótki opis kolekcji..."></textarea>
        </div>
        
        <!-- Set-specific fields -->
        <div class="form-group set-fields" hidden>
          <label for="set-select">Wybierz set</label>
          <select id="set-select" name="set_code">
            <option value="">-- Wybierz set --</option>
          </select>
        </div>
        
        <div class="form-group set-fields" hidden>
          <label>Rodzaj setu</label>
          <div class="radio-group horizontal">
            <label class="radio-option">
              <input type="radio" name="set_type" value="baseset" checked />
              <span class="radio-label">
                <strong>Baseset</strong>
                <small>Tylko karty podstawowe</small>
              </span>
            </label>
            <label class="radio-option">
              <input type="radio" name="set_type" value="masterset" />
              <span class="radio-label">
                <strong>Masterset</strong>
                <small>Wszystkie karty + secret rare</small>
              </span>
            </label>
          </div>
        </div>
        
        <!-- Artist-specific fields -->
        <div class="form-group artist-fields" hidden>
          <label for="artist-select">Wybierz artystę</label>
          <select id="artist-select" name="artist_name">
            <option value="">-- Wybierz artystę --</option>
          </select>
        </div>
        
        <div class="form-actions">
          <button type="button" class="button secondary" data-close-modal>Anuluj</button>
          <button type="submit" class="button primary">Utwórz kolekcję</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Camera Modal -->
<div class="fixed inset-0 z-50 hidden bg-black/95 flex flex-col" id="scan-modal">
  <div class="p-4 flex justify-between items-center bg-black border-b border-zinc-800">
    <h2 class="text-white text-sm font-medium">Skanuj kartę</h2>
    <button type="button" id="close-scan-modal" class="text-zinc-400 hover:text-white">
      <i data-lucide="x" class="w-6 h-6"></i>
    </button>
  </div>
  
  <div class="flex-1 relative overflow-hidden flex items-center justify-center bg-zinc-900">
    <video id="scan-video" autoplay playsinline class="absolute inset-0 w-full h-full object-cover"></video>
    
    <!-- Overlays -->
    <div class="absolute inset-0 pointer-events-none border-[2px] border-zinc-500/30 m-8 rounded-lg flex flex-col">
      <!-- Name Area (Top 20%) -->
      <div class="h-[20%] border-b-2 border-indigo-500/50 bg-indigo-500/10 relative">
        <span class="absolute top-2 left-2 text-[10px] text-indigo-300 uppercase font-bold tracking-wider">Nazwa</span>
      </div>
      
      <div class="flex-1"></div>
      
      <!-- Number Area (Bottom 15%) -->
      <div class="h-[15%] border-t-2 border-emerald-500/50 bg-emerald-500/10 relative">
        <span class="absolute bottom-2 right-2 text-[10px] text-emerald-300 uppercase font-bold tracking-wider">Numer</span>
      </div>
    </div>
    
    <div class="absolute bottom-8 left-0 right-0 flex justify-center gap-4 pointer-events-auto">
      <button id="capture-btn" class="w-16 h-16 rounded-full bg-white border-4 border-zinc-300 shadow-lg flex items-center justify-center active:scale-95 transition-transform">
        <div class="w-12 h-12 rounded-full bg-zinc-100 border border-zinc-300"></div>
      </button>
    </div>
    
    <div id="scan-loading" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center hidden z-50">
      <div class="animate-spin rounded-full h-10 w-10 border-4 border-indigo-500 border-t-transparent mb-4"></div>
      <p class="text-white text-sm" id="scan-status">Inicjalizacja...</p>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize icons
  lucide.createIcons();

  const collectionsGrid = document.getElementById('user-collections-grid');
  const emptyState = document.getElementById('collections-empty');
  const loadingState = document.getElementById('collections-loading');
  const modal = document.getElementById('new-collection-modal');
  const form = document.getElementById('new-collection-form');
  const setFields = document.querySelectorAll('.set-fields');
  const artistFields = document.querySelectorAll('.artist-fields');
  const collectionTypeInputs = document.querySelectorAll('input[name="collection_type"]');
  
  // Load collections
  async function loadCollections() {
    if(loadingState) loadingState.hidden = false;
    if(emptyState) emptyState.hidden = true;
    if(collectionsGrid) collectionsGrid.innerHTML = '';
    
    try {
      const response = await fetch('/collections/', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('kartoteka_token')}`
        }
      });
      
      if (!response.ok) throw new Error('Failed to load collections');
      
      const collections = await response.json();
      if(loadingState) loadingState.hidden = true;
      
      if (collections.length === 0) {
        if(emptyState) emptyState.hidden = false;
        return;
      }
      
      // Show max 6 collections
      collections.slice(0, 6).forEach(renderCollectionCard);
    } catch (error) {
      console.error('Error loading collections:', error);
      if(loadingState) loadingState.hidden = true;
      if(emptyState) emptyState.hidden = false;
    }
  }
  
  function renderCollectionCard(collection) {
    if(!collectionsGrid) return;
    const card = document.createElement('a');
    card.href = `/my-collections/${collection.id}`;
    card.className = 'collection-card';
    
    const typeIcon = {
      'custom': '&#9733;',
      'set': '&#128230;',
      'artist': '&#127912;'
    }[collection.collection_type] || '&#128451;';
    
    const typeLabel = {
      'custom': 'Własna',
      'set': collection.set_type === 'masterset' ? 'Masterset' : 'Baseset',
      'artist': 'Artysta'
    }[collection.collection_type] || 'Kolekcja';
    
    const subtitle = collection.set_name || collection.artist_name || '';
    
    card.innerHTML = `
      <div class="collection-cover" style="${collection.cover_image ? `background-image: url('${collection.cover_image}')` : ''}">
        ${!collection.cover_image ? `<span class="collection-icon">${typeIcon}</span>` : ''}
      </div>
      <div class="collection-info">
        <span class="collection-type-badge">${typeLabel}</span>
        <h3 class="collection-name">${collection.name}</h3>
        ${subtitle ? `<p class="collection-subtitle">${subtitle}</p>` : ''}
        <div class="collection-progress">
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${collection.progress_percent}%"></div>
          </div>
          <span class="progress-text">${collection.owned_cards}/${collection.total_cards} (${collection.progress_percent.toFixed(1)}%)</span>
        </div>
      </div>
    `;
    
    collectionsGrid.appendChild(card);
  }
  
  // Toggle fields based on collection type
  if(collectionTypeInputs.length > 0) {
      collectionTypeInputs.forEach(input => {
        input.addEventListener('change', function() {
          const type = this.value;
          
          setFields.forEach(el => el.hidden = type !== 'set');
          artistFields.forEach(el => el.hidden = type !== 'artist');
          
          // Load sets or artists if needed
          if (type === 'set') {
            loadSets();
          } else if (type === 'artist') {
            loadArtists();
          }
        });
      });
  }
  
  async function loadSets() {
    const select = document.getElementById('set-select');
    if (!select || select.options.length > 1) return; // Already loaded
    
    try {
      const response = await fetch('/collections/sets/list');
      if (!response.ok) throw new Error('Failed to load sets');
      
      const sets = await response.json();
      sets.forEach(set => {
        const option = document.createElement('option');
        option.value = set.code;
        option.textContent = `${set.name} (${set.code}) - ${set.total_cards || '?'} kart`;
        select.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading sets:', error);
    }
  }
  
  async function loadArtists() {
    const select = document.getElementById('artist-select');
    if (!select || select.options.length > 1) return; // Already loaded
    
    try {
      const response = await fetch('/collections/artists/list');
      if (!response.ok) throw new Error('Failed to load artists');
      
      const artists = await response.json();
      artists.forEach(artist => {
        const option = document.createElement('option');
        option.value = artist.name;
        option.textContent = `${artist.name} (${artist.card_count} kart)`;
        select.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading artists:', error);
    }
  }
  
  // Modal handlers
  function openModal() {
    if(modal) {
        modal.hidden = false;
        document.body.style.overflow = 'hidden';
    }
  }
  
  function closeModal() {
    if(modal) {
        modal.hidden = true;
        document.body.style.overflow = '';
        if(form) {
            form.reset();
            setFields.forEach(el => el.hidden = true);
            artistFields.forEach(el => el.hidden = true);
        }
    }
  }
  
  const newCollectionBtn = document.getElementById('new-collection-btn');
  if(newCollectionBtn) newCollectionBtn.addEventListener('click', openModal);
  
  if(modal) {
      modal.querySelectorAll('[data-close-modal]').forEach(btn => {
        btn.addEventListener('click', closeModal);
      });
      
      modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
      });
  }
  
  // Form submission
  if(form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const type = formData.get('collection_type');
        
        const payload = {
          name: formData.get('name'),
          description: formData.get('description') || null,
          collection_type: type
        };
        
        if (type === 'set') {
          payload.set_code = formData.get('set_code');
          payload.set_type = formData.get('set_type');
          
          if (!payload.set_code) {
            alert('Wybierz set');
            return;
          }
        } else if (type === 'artist') {
          payload.artist_name = formData.get('artist_name');
          
          if (!payload.artist_name) {
            alert('Wybierz artystę');
            return;
          }
        }
        
        try {
          const response = await fetch('/collections/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('kartoteka_token')}`
            },
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to create collection');
          }
          
          closeModal();
          loadCollections();
        } catch (error) {
          console.error('Error creating collection:', error);
          alert('Błąd: ' + error.message);
        }
      });
  }
  
  // Initial load
  loadCollections();
});
</script>
{% endblock %}
